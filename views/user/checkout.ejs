<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FitVibe - Checkout</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      color: #1e293b;
      line-height: 1.6;
    }

    .checkout-section {
      max-width: 1400px;
      margin: 0 auto;
      padding: 4rem 1.5rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
      align-items: start;
    }

    .checkout-section h2 {
      font-size: 2rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 2rem;
      letter-spacing: -0.025em;
      position: relative;
    }

    .checkout-section h2::after {
      content: '';
      position: absolute;
      bottom: -0.5rem;
      left: 0;
      width: 60px;
      height: 4px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
    }

    .checkout-address {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .checkout-address::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .address-list {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .address-card {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .address-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .address-card.default,
    .address-card:has(input:checked) {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    }

    .address-card input[type="radio"] {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 20px;
      height: 20px;
      accent-color: #667eea;
    }

    .address-card p {
      margin: 0.5rem 0;
      color: #64748b;
      font-size: 0.875rem;
    }

    .address-card p strong {
      color: #0f172a;
      font-weight: 600;
      font-size: 1rem;
    }

    .address-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .address-actions button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }

    .set-default-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      box-shadow: 0 4px 6px -1px rgba(102, 126, 234, 0.3);
    }

    .set-default-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(102, 126, 234, 0.4);
    }

    .set-default-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .edit-btn {
      background: #ffffff;
      color: #6b7280;
      border: 2px solid #e5e7eb;
    }

    .edit-btn:hover {
      background: #f9fafb;
      border-color: #667eea;
      color: #667eea;
    }

    .add-address-btn {
      width: 100%;
      padding: 1rem 2rem;
      background: #ffffff;
      color: #667eea;
      border: 2px dashed #667eea;
      border-radius: 16px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .add-address-btn:hover {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
      border-style: solid;
    }

    .address-form {
      display: none;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 2rem;
      margin-top: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .address-form.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    .address-form input {
      width: 100%;
      padding: 0.875rem 1rem;
      margin: 0.5rem 0;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      outline: none;
      background: #ffffff;
      color: #111827;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .address-form input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .address-form button {
      width: 100%;
      padding: 0.875rem 1.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
      margin-top: 1rem;
    }

    .address-form button:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
    }

    .checkout-order {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
      height: fit-content;
      position: sticky;
      top: 2rem;
    }

    .checkout-order::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .order-items {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .order-item {
      display: flex;
      align-items: center;
      background: #f8fafc;
      padding: 1.5rem;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .order-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .order-item img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 12px;
      margin-right: 1.5rem;
      flex-shrink: 0;
    }

    .order-item-details {
      flex: 1;
    }

    .order-item-details h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }

    .order-item-details p {
      font-size: 0.875rem;
      color: #64748b;
      margin-bottom: 0.25rem;
    }

    .order-item-details .item-price {
      font-weight: 600;
      color: #059669;
      font-size: 1rem;
    }

    /* Coupon Section Styles */
    .coupon-section {
      background: #f8fafc;
      padding: 1.5rem;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      margin-bottom: 2rem;
    }

    .coupon-section h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .coupon-section h3 i {
      color: #667eea;
    }

    .coupon-input-group {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .coupon-input-group input {
      flex: 1;
      padding: 0.875rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      outline: none;
      background: #ffffff;
      color: #111827;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      text-transform: uppercase;
    }

    .coupon-input-group input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .apply-coupon-btn {
      padding: 0.875rem 1.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      white-space: nowrap;
    }

    .apply-coupon-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(102, 126, 234, 0.4);
    }

    .apply-coupon-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }

    .coupon-message {
      font-size: 0.875rem;
      margin-top: 0.5rem;
      padding: 0.5rem;
      border-radius: 6px;
      display: none;
    }

    .coupon-message.success {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(21, 128, 61, 0.1) 100%);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.2);
      display: block;
    }

    .coupon-message.error {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(185, 28, 28, 0.1) 100%);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.2);
      display: block;
    }

    .applied-coupon {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(21, 128, 61, 0.1) 100%);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 12px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .coupon-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .coupon-details {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .coupon-code-display {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-weight: 600;
      color: #22c55e;
      font-size: 0.875rem;
    }

    .coupon-discount {
      font-size: 0.75rem;
      color: #059669;
      font-weight: 500;
    }

    .remove-coupon-btn {
      padding: 0.5rem 1rem;
      background: #ffffff;
      color: #ef4444;
      border: 1px solid #ef4444;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.75rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .remove-coupon-btn:hover {
      background: #ef4444;
      color: #ffffff;
    }

    .order-summary {
      background: #f8fafc;
      padding: 1.5rem;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      margin-bottom: 2rem;
    }

    .order-summary p {
      display: flex;
      justify-content: space-between;
      margin: 0.75rem 0;
      font-size: 0.875rem;
      color: #64748b;
    }

    .order-summary .total {
      font-size: 1.25rem;
      font-weight: 700;
      color: #0f172a;
      border-top: 1px solid #e2e8f0;
      padding-top: 0.75rem;
      margin-top: 1rem;
    }

    .order-summary .discount {
      color: #059669;
    }

    .coupon-discount-row {
      color: #059669 !important;
    }

    .payment-methods {
      margin-bottom: 2rem;
    }

    .payment-methods h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 1rem;
    }

    .payment-methods label {
      display: flex;
      align-items: center;
      padding: 1rem;
      margin: 0.75rem 0;
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      color: #374151;
    }

    .payment-methods label:hover {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    }

    .payment-methods label:has(input:checked) {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      color: #667eea;
    }

    .payment-methods input[type="radio"] {
      margin-right: 0.75rem;
      width: 18px;
      height: 18px;
      accent-color: #667eea;
    }

    .payment-methods i {
      margin-left: auto;
      font-size: 1.25rem;
    }

    .place-order-btn {
      width: 100%;
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.125rem;
      transition: all 0.3s ease;
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .place-order-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
    }

    .place-order-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .empty-cart {
      text-align: center;
      padding: 3rem 2rem;
      color: #64748b;
    }

    .empty-cart i {
      font-size: 4rem;
      color: #d1d5db;
      margin-bottom: 1rem;
    }

    .empty-cart p {
      font-size: 1.125rem;
      margin-bottom: 2rem;
    }

    .continue-shopping-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      text-decoration: none;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .continue-shopping-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
      color: #ffffff;
      text-decoration: none;
    }

    @media (max-width: 1024px) {
      .checkout-section {
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      .checkout-order {
        position: static;
      }
    }

    @media (max-width: 768px) {
      .checkout-section {
        padding: 2rem 1rem;
      }

      .checkout-section h2 {
        font-size: 1.75rem;
      }

      .checkout-address,
      .checkout-order {
        padding: 1.5rem;
      }

      .order-item {
        flex-direction: column;
        align-items: flex-start;
        text-align: center;
      }

      .order-item img {
        width: 100%;
        max-width: 120px;
        margin-bottom: 1rem;
        margin-right: 0;
        align-self: center;
      }

      .address-actions {
        flex-direction: column;
      }

      .address-actions button {
        width: 100%;
      }

      .coupon-input-group {
        flex-direction: column;
      }

      .apply-coupon-btn {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .checkout-section h2 {
        font-size: 1.5rem;
      }

      .order-item-details h3 {
        font-size: 1rem;
      }

      .place-order-btn {
        font-size: 1rem;
        padding: 0.875rem 1.5rem;
      }
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>

<body>
  <%- include('./partials/header') %>

  <div class="checkout-section">
    <div class="checkout-address">
      <h2><i class="fas fa-map-marker-alt"></i> Shipping Address</h2>
      <% if (addresses && addresses.length > 0) { %>
        <div class="address-list">
          <% addresses.forEach(address => { %>
            <div class="address-card <%= address.isDefault ? 'default' : '' %>">
              <input type="radio" name="address" value="<%= address._id %>" <%= address.isDefault ? 'checked' : '' %>>
              <p><strong><%= address.name %></strong></p>
              <p><%= address.address || 'N/A' %>, <%= address.city %>, <%= address.state %> <%= address.zipCode %></p>
              <p><%= address.country %></p>
              <p><i class="fas fa-phone"></i> <%= address.phone %></p>
              <div class="address-actions">
                <button class="set-default-btn" data-address-id="<%= address._id %>" <%= address.isDefault ? 'disabled' : '' %>>
                  <i class="fas fa-star"></i>
                  <%= address.isDefault ? 'Default' : 'Set as Default' %>
                </button>
                <button class="edit-btn" data-address-id="<%= address._id %>">
                  <i class="fas fa-edit"></i>
                  Edit
                </button>
              </div>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <div class="empty-cart">
          <i class="fas fa-map-marker-alt"></i>
          <p>No addresses found. Please add an address.</p>
        </div>
      <% } %>
      
      <button class="add-address-btn">
        <i class="fas fa-plus"></i>
        Add New Address
      </button>
      
      <form class="address-form" id="addressForm" action="/profile/address/edit" method="POST">
        <input type="hidden" name="addressId" id="addressId">
        <input type="text" name="name" placeholder="Full Name" required>
        <input type="text" name="address" placeholder="Street Address" required>
        <input type="text" name="city" placeholder="City" required>
        <input type="text" name="state" placeholder="State" required>
        <input type="text" name="zipCode" placeholder="Zip Code" required>
        <input type="text" name="country" placeholder="Country" required>
        <input type="text" name="phone" placeholder="Phone Number" required>
        <button type="submit">
          <i class="fas fa-save"></i>
          Save Address
        </button>
      </form>
    </div>

    <div class="checkout-order">
      <h2><i class="fas fa-shopping-bag"></i> Order Summary</h2>
      <% if (cart && cart.items.length > 0) { %>
        <div class="order-items">
          <% cart.items.forEach(item => { %>
            <div class="order-item">
              <img src="<%= item.productId && item.productId.images && item.productId.images.length > 0 ? item.productId.images[0].url : '/images/default-product.jpg' %>" 
                   alt="<%= item.productId ? item.productId.name : 'Product' %>" loading="lazy" />
              <div class="order-item-details">
                <h3><%= item.productId ? item.productId.name : 'Product Name' %></h3>
                <p><strong>Quantity:</strong> <%= item.quantity %></p>
                <p><strong>Size:</strong> <%= item.variant?.size || 'N/A' %></p>
                <p class="item-price">₹<%= item.variant ? (item.variant.salePrice * item.quantity).toLocaleString('en-IN', { minimumFractionDigits: 2 }) : '0.00' %></p>
              </div>
            </div>
          <% }) %>
        </div>
        
        <!-- Coupon Section -->
        <div class="coupon-section">
          <h3><i class="fas fa-ticket-alt"></i> Apply Coupon</h3>
          <div class="coupon-input-container" id="couponInputContainer">
            <div class="coupon-input-group">
              <input type="text" id="couponCode" placeholder="Enter coupon code" maxlength="20">
              <button type="button" id="applyCouponBtn" class="apply-coupon-btn">
                <i class="fas fa-check"></i>
                Apply
              </button>
            </div>
            <div class="coupon-message" id="couponMessage"></div>
          </div>
          
          <div class="applied-coupon" id="appliedCoupon" style="display: none;">
            <div class="coupon-info">
              <div class="coupon-details">
                <span class="coupon-code-display" id="appliedCouponCode"></span>
                <span class="coupon-discount" id="appliedCouponDiscount"></span>
              </div>
              <button type="button" id="removeCouponBtn" class="remove-coupon-btn">
                <i class="fas fa-times"></i>
                Remove
              </button>
            </div>
          </div>
        </div>

        <div class="order-summary" id="orderSummary">
          <p><span>Subtotal:</span> <span id="subtotalAmount">₹<%= subtotal.toLocaleString('en-IN', { minimumFractionDigits: 2 }) %></span></p>
          <% if (tax > 0) { %>
            <p><span>GST (5%):</span> <span id="taxAmount">₹<%= tax.toLocaleString('en-IN', { minimumFractionDigits: 2 }) %></span></p>
          <% } %>
          <% if (discount > 0) { %>
            <p class="discount"><span>Discount (10%):</span> <span id="discountAmount">-₹<%= discount.toLocaleString('en-IN', { minimumFractionDigits: 2 }) %></span></p>
          <% } %>
          <p class="coupon-discount-row" id="couponDiscountRow" style="display: none;">
            <span>Coupon Discount:</span> 
            <span id="couponDiscountAmount" class="discount">-₹0.00</span>
          </p>
          <p><span>Shipping:</span> <span id="shippingAmount">₹<%= shipping.toLocaleString('en-IN', { minimumFractionDigits: 2 }) %></span></p>
          <p class="total"><span>Total:</span> <span id="totalAmount">₹<%= total.toLocaleString('en-IN', { minimumFractionDigits: 2 }) %></span></p>
        </div>

        <div class="payment-methods">
          <h3>Select Payment Method</h3>
          <label>
            <input type="radio" name="paymentMethod" value="COD" checked>
            <span>Cash on Delivery</span>
            <i class="fas fa-money-bill-wave"></i>
          </label>
          <label>
            <input type="radio" name="paymentMethod" value="Online">
            <span>Online Payment</span>
            <i class="fas fa-credit-card"></i>
          </label>
        </div>

        <% const isOutOfStock = cart.items.some(item => 
          item.productId && 
          item.productId.variants && 
          item.variant && 
          item.variant.varientquatity < item.quantity
        ); %>

        <% const hasSelectedAddress = addresses && addresses.length > 0; %>

        <button class="place-order-btn" <%= !hasSelectedAddress || isOutOfStock ? 'disabled' : '' %>>
          <i class="fas fa-check-circle"></i>
          Place Order
        </button>
      <% } else { %>
        <div class="empty-cart">
          <i class="fas fa-shopping-cart"></i>
          <p>Your cart is empty.</p>
          <a href="/products" class="continue-shopping-btn">
            <i class="fas fa-shopping-bag"></i>
            Continue Shopping
          </a>
        </div>
      <% } %>
    </div>
  </div>

  <%- include('./partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true,
      didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer);
        toast.addEventListener('mouseleave', Swal.resumeTimer);
      }
    });

    // Global variables for coupon management
    let appliedCouponData = null;
    let originalTotals = {
      subtotal: <%= subtotal %>,
      tax: <%= tax %>,
      discount: <%= discount %>,
      shipping: <%= shipping %>,
      total: <%= total %> 
    };

    // Coupon functionality
    document.addEventListener('DOMContentLoaded', function() {
      const couponCodeInput = document.getElementById('couponCode');
      const applyCouponBtn = document.getElementById('applyCouponBtn');
      const removeCouponBtn = document.getElementById('removeCouponBtn');
      const couponMessage = document.getElementById('couponMessage');
      const appliedCouponDiv = document.getElementById('appliedCoupon');
      const couponInputContainer = document.getElementById('couponInputContainer');

      // Auto-format coupon code to uppercase
      couponCodeInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
      });

      // Apply coupon on Enter key
      couponCodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          applyCoupon();
        }
      });

      // Apply coupon button click
      applyCouponBtn.addEventListener('click', applyCoupon);

      // Remove coupon button click
      removeCouponBtn.addEventListener('click', removeCoupon);

      async function applyCoupon() {
        const couponCode = couponCodeInput.value.trim();
        
        if (!couponCode) {
          showCouponMessage('Please enter a coupon code', 'error');
          return;
        }

        // Disable button and show loading
        applyCouponBtn.disabled = true;
        applyCouponBtn.innerHTML = '<span class="spinner"></span> Applying...';
        
        try {
          const response = await fetch('/coupon/apply', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ couponCode })
          });

          const result = await response.json();

          if (result.success) {
            appliedCouponData = result.coupon;
            updateOrderSummary(result.totals);
            showAppliedCoupon(result.coupon);
            showCouponMessage(`Coupon applied! You saved ₹${result.coupon.discountAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`, 'success');
            
            // Hide input container and show applied coupon
            couponInputContainer.style.display = 'none';
            appliedCouponDiv.style.display = 'block';
          } else {
            showCouponMessage(result.message, 'error');
          }
        } catch (error) {
          console.error('Error applying coupon:', error);
          
          // Check if it's a network error or server error
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            showCouponMessage('Network error. Please check your connection and try again.', 'error');
          } else if (error.message) {
            showCouponMessage(error.message, 'error');
          } else {
            showCouponMessage('Error applying coupon. Please try again.', 'error');
          }
        } finally {
          applyCouponBtn.disabled = false;
          applyCouponBtn.innerHTML = '<i class="fas fa-check"></i> Apply';
        }
      }

      async function removeCoupon() {
        removeCouponBtn.disabled = true;
        removeCouponBtn.innerHTML = '<span class="spinner"></span> Removing...';

        try {
          const response = await fetch('/coupon/remove', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          const result = await response.json();

          if (result.success) {
            appliedCouponData = null;
            updateOrderSummary(result.totals);
            hideAppliedCoupon();
            showCouponMessage('Coupon removed successfully', 'success');
            
            // Show input container and hide applied coupon
            couponInputContainer.style.display = 'block';
            appliedCouponDiv.style.display = 'none';
            
            // Clear input
            couponCodeInput.value = '';
          } else {
            showCouponMessage(result.message, 'error');
          }
        } catch (error) {
          console.error('Error removing coupon:', error);
          showCouponMessage('Error removing coupon. Please try again.', 'error');
        } finally {
          removeCouponBtn.disabled = false;
          removeCouponBtn.innerHTML = '<i class="fas fa-times"></i> Remove';
        }
      }

      function showCouponMessage(message, type) {
        couponMessage.textContent = message;
        couponMessage.className = `coupon-message ${type}`;
        couponMessage.style.display = 'block';
        
        // Hide message after 5 seconds
        setTimeout(() => {
          couponMessage.style.display = 'none';
        }, 5000);
      }

      function showAppliedCoupon(coupon) {
        const codeElement = document.getElementById('appliedCouponCode');
        const discountElement = document.getElementById('appliedCouponDiscount');
        
        if (codeElement) {
          codeElement.textContent = coupon.code;
        }
        
        if (discountElement) {
          let discountText = '';
          if (coupon.discountType === 'percentage') {
            discountText = `${coupon.discountValue}% off - Saved ₹${coupon.discountAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
          } else {
            discountText = `₹${coupon.discountValue} off - Saved ₹${coupon.discountAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
          }
          discountElement.textContent = discountText;
        }
      }

      function hideAppliedCoupon() {
        const codeElement = document.getElementById('appliedCouponCode');
        const discountElement = document.getElementById('appliedCouponDiscount');
        
        if (codeElement) {
          codeElement.textContent = '';
        }
        
        if (discountElement) {
          discountElement.textContent = '';
        }
      }

      function updateOrderSummary(totals) {
        // Update all amounts with null checks
        const subtotalElement = document.getElementById('subtotalAmount');
        if (subtotalElement) {
          subtotalElement.textContent = `₹${totals.subtotal.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
        }
        
        const taxElement = document.getElementById('taxAmount');
        if (taxElement) {
          taxElement.textContent = `₹${totals.tax.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
        }
        
        const discountElement = document.getElementById('discountAmount');
        if (discountElement) {
          discountElement.textContent = `-₹${totals.discount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
        }
        
        const shippingElement = document.getElementById('shippingAmount');
        if (shippingElement) {
          shippingElement.textContent = `₹${totals.shipping.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
        }
        
        const totalElement = document.getElementById('totalAmount');
        if (totalElement) {
          totalElement.textContent = `₹${totals.total.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
        }
        
        // Show/hide coupon discount row
        const couponDiscountRow = document.getElementById('couponDiscountRow');
        const couponDiscountAmount = document.getElementById('couponDiscountAmount');
        
        if (couponDiscountRow && couponDiscountAmount) {
          if (totals.couponDiscount && totals.couponDiscount > 0) {
            couponDiscountAmount.textContent = `-₹${totals.couponDiscount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            couponDiscountRow.style.display = 'flex';
          } else {
            couponDiscountRow.style.display = 'none';
          }
        }
      }
    });

    // Set Default Address
    document.querySelectorAll('.set-default-btn').forEach(button => {
      button.addEventListener('click', async () => {
        const addressId = button.getAttribute('data-address-id');
        
        button.disabled = true;
        button.innerHTML = '<span class="spinner"></span> Setting...';

        try {
          const res = await fetch('/address/set-default', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ addressId })
          });

          const data = await res.json();
          if (data.success) {
            Toast.fire({
              icon: 'success',
              title: 'Default address updated successfully!'
            });
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            Toast.fire({
              icon: 'error',
              title: 'Failed to set default address'
            });
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-star"></i> Set as Default';
          }
        } catch (err) {
          Toast.fire({
            icon: 'error',
            title: 'Error setting default address'
          });
          button.disabled = false;
          button.innerHTML = '<i class="fas fa-star"></i> Set as Default';
        }
      });
    });

    // Toggle Address Form
    document.querySelector('.add-address-btn').addEventListener('click', () => {
      const form = document.getElementById('addressForm');
      form.classList.toggle('active');
      if (form.classList.contains('active')) {
        form.reset();
        document.getElementById('addressId').value = '';
        form.scrollIntoView({ behavior: 'smooth' });
      }
    });

    // Edit Address
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', async () => {
          const addressId = button.getAttribute('data-address-id');
          
          button.disabled = true;
          button.innerHTML = '<span class="spinner"></span> Loading...';
          
          try {
            const response = await fetch(`/address/${addressId}`);
            const address = await response.json();
            const form = document.getElementById('addressForm');
            
            form.classList.add('active');
            form.querySelector('#addressId').value = address._id;
            form.querySelector('[name="name"]').value = address.name;
            form.querySelector('[name="address"]').value = address.address;
            form.querySelector('[name="city"]').value = address.city;
            form.querySelector('[name="state"]').value = address.state;
            form.querySelector('[name="zipCode"]').value = address.zipCode;
            form.querySelector('[name="country"]').value = address.country;
            form.querySelector('[name="phone"]').value = address.phone;
            
            form.scrollIntoView({ behavior: 'smooth' });
            
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-edit"></i> Edit';
          } catch (err) {
            console.error('Error loading address:', err);
            Toast.fire({
              icon: 'error',
              title: 'Failed to load address'
            });
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-edit"></i> Edit';
          }
        });
      });
    });

    // Save Address
    document.getElementById('addressForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span> Saving...';
      
      try {
        const response = await fetch('/save-address', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          Toast.fire({
            icon: 'success',
            title: 'Address saved successfully!'
          });
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          Toast.fire({
            icon: 'error',
            title: 'Failed to save address'
          });
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Address';
        }
      } catch (error) {
        Toast.fire({
          icon: 'error',
          title: 'Error saving address'
        });
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Address';
      }
    });

    // Handle address selection
    document.querySelectorAll('input[name="address"]').forEach(radio => {
      radio.addEventListener('change', () => {
        document.querySelectorAll('.address-card').forEach(card => {
          card.classList.remove('default');
        });
        
        const selectedCard = radio.closest('.address-card');
        if (selectedCard) {
          selectedCard.classList.add('default');
        }
        
        const placeOrderBtn = document.querySelector('.place-order-btn');
        if (placeOrderBtn) {
          placeOrderBtn.disabled = false;
        }
      });
    });

    // Place Order - Updated to include coupon data
    document.querySelector('.place-order-btn').addEventListener('click', async () => {
      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
      const addressId = document.querySelector('input[name="address"]:checked')?.value;
      
      if (!addressId) {
        Toast.fire({
          icon: 'warning',
          title: 'Please select a delivery address'
        });
        return;
      }

      const placeOrderBtn = document.querySelector('.place-order-btn');
      placeOrderBtn.disabled = true;
      placeOrderBtn.innerHTML = '<span class="spinner"></span> Placing Order...';

      // Prepare order data with coupon information
      const orderData = {
        paymentMethod,
        addressId
      };

      // Add coupon data if applied
      if (appliedCouponData) {
        orderData.couponCode = appliedCouponData.code;
        orderData.couponDiscount = appliedCouponData.discountAmount;
      }

      try {
        console.log('Placing order with:', orderData);
        
        const response = await fetch('/order/place', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });

        const result = await response.json();
        console.log('Order response:', result);

        if (!result.success) {
          Toast.fire({
            icon: 'error',
            title: result.message || 'Failed to place order'
          });
          placeOrderBtn.disabled = false;
          placeOrderBtn.innerHTML = '<i class="fas fa-check-circle"></i> Place Order';
          return;
        }

        if (paymentMethod === 'Online') {
          // Check if Razorpay is loaded
          if (typeof Razorpay === 'undefined') {
            Toast.fire({
              icon: 'error',
              title: 'Payment gateway not loaded. Please refresh and try again.'
            });
            placeOrderBtn.disabled = false;
            placeOrderBtn.innerHTML = '<i class="fas fa-check-circle"></i> Place Order';
            return;
          }

          console.log('Initializing Razorpay with:', {
            key: result.key_id,
            amount: result.amount,
            currency: result.currency,
            order_id: result.razorpayOrderId
          });

          const options = {
            key: result.key_id,
            amount: result.amount,
            currency: result.currency,
            name: 'FitVibe',
            description: 'Order Payment',
            order_id: result.razorpayOrderId,
            handler: async function (response) {
              try {
                console.log('Payment successful:', response);
                
                const verifyResponse = await fetch('/order/verify-payment', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    orderId: result.orderId,
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_signature: response.razorpay_signature
                  })
                });

                const verifyResult = await verifyResponse.json();
                console.log('Verification result:', verifyResult);
                
                if (verifyResult.success) {
                  // Redirect to success page immediately
                  window.location.href = `/order/success/${result.orderId}`;
                } else {
                  Toast.fire({
                    icon: 'error',
                    title: verifyResult.message || 'Payment verification failed'
                  });
                  placeOrderBtn.disabled = false;
                  placeOrderBtn.innerHTML = '<i class="fas fa-check-circle"></i> Place Order';
                }
              } catch (error) {
                console.error('Error verifying payment:', error);
                Toast.fire({
                  icon: 'error',
                  title: 'Error verifying payment. Please contact support.'
                });
                placeOrderBtn.disabled = false;
                placeOrderBtn.innerHTML = '<i class="fas fa-check-circle"></i> Place Order';
              }
            },
            prefill: {
              name: result.user?.name || '',
              email: result.user?.email || '',
              contact: result.user?.phone || ''
            },
            theme: {
              color: '#667eea'
            },
            modal: {
              ondismiss: function() {
                console.log('Payment modal dismissed');
                
                // Record payment cancellation and redirect to failure page
                fetch('/order/fail', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    orderId: result.orderId,
                    error: { description: 'Payment cancelled by user', code: 'PAYMENT_CANCELLED' },
                    razorpay_order_id: result.razorpayOrderId,
                    razorpay_payment_id: null
                  })
                }).then(failureResponse => failureResponse.json())
                  .then(failureResult => {
                    console.log('Payment cancellation recorded:', failureResult);
                    if (failureResult.success && failureResult.redirectUrl) {
                      window.location.href = failureResult.redirectUrl;
                    } else {
                      window.location.href = `/order/failure/${result.orderId}`;
                    }
                  })
                  .catch(error => {
                    console.error('Error recording payment cancellation:', error);
                    window.location.href = `/order/failure/${result.orderId}`;
                  });
              }
            }
          };

          console.log('Opening Razorpay with options:', options);
          
          const rzp = new Razorpay(options);
          
          // Payment failure handler
          rzp.on('payment.failed', function (response) {
            console.error('Payment failed:', response);
            
            // Record payment failure and redirect to failure page immediately
            fetch('/order/fail', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                orderId: result.orderId,
                error: response.error,
                razorpay_order_id: result.razorpayOrderId,
                razorpay_payment_id: response.error?.metadata?.payment_id || null
              })
            }).then(failureResponse => failureResponse.json())
              .then(failureResult => {
                console.log('Payment failure recorded:', failureResult);
                
                // Redirect to failure page immediately
                if (failureResult.success && failureResult.redirectUrl) {
                  window.location.href = failureResult.redirectUrl;
                } else {
                  window.location.href = `/order/failure/${result.orderId}`;
                }
              })
              .catch(error => {
                console.error('Error recording payment failure:', error);
                window.location.href = `/order/failure/${result.orderId}`;
              });
          });

          // Reset button state before opening modal
          placeOrderBtn.disabled = false;
          placeOrderBtn.innerHTML = '<i class="fas fa-check-circle"></i> Place Order';
          
          rzp.open();
        } else {
          // COD order
          Toast.fire({
            icon: 'success',
            title: 'Order placed successfully!'
          });
          setTimeout(() => {
            window.location.href = `/order/success/${result.orderId}`;
          }, 1000);
        }
      } catch (error) {
        console.error('Error placing order:', error);
        Toast.fire({
          icon: 'error',
          title: 'Error placing order. Please try again.'
        });
        placeOrderBtn.disabled = false;
        placeOrderBtn.innerHTML = '<i class="fas fa-check-circle"></i> Place Order';
      }
    });

    // Add fade-in animation on page load
    document.addEventListener('DOMContentLoaded', () => {
      const elements = document.querySelectorAll('.checkout-address, .checkout-order');
      elements.forEach((el, index) => {
        setTimeout(() => {
          el.classList.add('fade-in');
        }, index * 200);
      });
    });
  </script>
</body>

</html>