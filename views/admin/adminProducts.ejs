<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - FitVibe Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin/products.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
   

</head>

<body>
    <%- include('./partials/sidebar', { page: 'products' }) %>

        <div class="main-content">
            <%- include('./partials/header', { pageTitle: 'Product Management' , adminName: admin.name || 'Admin' ,
                breadcrumbs: [ { name: 'Dashboard' , url: '/admin/dashboard' }, { name: 'Products' ,
                url: '/admin/products' } ] }) %>


                <div class="card mb-4">
                    <div class="card-body">
                        <form method="GET" action="/admin/products" class="row g-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control" name="search" placeholder="Search products..."
                                    value="<%= searchQuery %>">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" name="category">
                                    <option value="">All Categories</option>
                                    <% categories.forEach(cat=> { %>
                                        <option value="<%= cat._id %>" <%=category===cat._id.toString() ? 'selected'
                                            : '' %>>
                                            <%= cat.name %>
                                        </option>
                                        <% }) %>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" name="isActive">
                                    <option value="">All Status</option>
                                    <option value="true" <%=isActiveFilter==='true' ? 'selected' : '' %>>Active</option>
                                    <option value="false" <%=isActiveFilter==='false' ? 'selected' : '' %>>Inactive
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" name="sortBy">
                                    <option value="createdAt" <%=sortBy==='createdAt' ? 'selected' : '' %>>Date Created
                                    </option>
                                    <option value="name" <%=sortBy==='name' ? 'selected' : '' %>>Name</option>
                                    <option value="price" <%=sortBy==='price' ? 'selected' : '' %>>Price</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <select class="form-select" name="sortOrder">
                                    <option value="desc" <%=sortOrder==='desc' ? 'selected' : '' %>>Desc</option>
                                    <option value="asc" <%=sortOrder==='asc' ? 'selected' : '' %>>Asc</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search"></i> Filter
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4>Products (<%= totalProducts %>)</h4>
                    <a href="/admin/addproducts" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add New Product
                    </a>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Image</th>
                                        <th>Product Name</th>
                                        <th>Category</th>
                                        <th>Price Range</th>
                                        <th>Stock</th>
                                        <th>Offer</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (products && products.length> 0) { %>
                                        <% products.forEach(product=> { %>
                                            <tr>
                                                <td>
                                                    <% if (product.images && product.images.length> 0) { %>
                                                        <a href="/admin/product/<%= product._id %>"
                                                            class="product-image-link">
                                                            <img src="<%= product.images[0].thumbnail || product.images[0].url %>"
                                                                alt="<%= product.name %>" class="product-thumbnail">

                                                            <% } else { %>
                                                                <div class="no-image">No Image</div>
                                                                <% } %>
                                                </td>
                                                <td>
                                                    <div class="product-info">
                                                        <h6 class="mb-1">
                                                            <%= product.name %>
                                                        </h6>
                                                        <small class="text-muted">SKU: <%= product.sku || 'N/A' %>
                                                                </small>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge bg-secondary">
                                                        <%= product.categoryId.name %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <% if (product.variants && product.variants.length> 0) { %>
                                                        <% const prices=product.variants.map(v=>
                                                            v.varientPrice).filter(p => p > 0) %>
                                                            <% if (prices.length> 0) { %>
                                                                ₹<%= Math.min(...prices) %> - ₹<%= Math.max(...prices)
                                                                        %>
                                                                        <% } else { %>
                                                                            N/A
                                                                            <% } %>
                                                                                <% } else { %>
                                                                                    N/A
                                                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (product.variants && product.variants.length> 0) { %>
                                                        <% const totalStock=product.variants.reduce((sum, v)=> sum +
                                                            (v.varientquatity || 0), 0) %>
                                                            <span
                                                                class="badge <%= totalStock > 10 ? 'bg-success' : totalStock > 0 ? 'bg-warning' : 'bg-danger' %>">
                                                                <%= totalStock %>
                                                            </span>
                                                            <% } else { %>
                                                                <span class="badge bg-secondary">N/A</span>
                                                                <% } %>
                                                </td>
                                                <td>
                                                    <% if (product.displayOffer> 0) { %>
                                                        <span class="badge bg-info">
                                                            <%= product.displayOffer %>% OFF
                                                        </span>
                                                        <br>
                                                        <small class="text-muted">(<%= product.offerSource %>)</small>
                                                        <% } else { %>
                                                            <span class="text-muted">No Offer</span>
                                                            <% } %>
                                                </td>
                                                <td>
                                                    <span
                                                        class="badge <%= product.isListed ? 'bg-success' : 'bg-danger' %>">
                                                        <%= product.isListed ? 'Active' : 'Inactive' %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <a href="/admin/editproducts?id=<%= product._id %>"
                                                            class="btn btn-sm btn-outline-primary" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <button type="button"
                                                            class="btn btn-sm <%= product.isListed ? 'btn-outline-warning' : 'btn-outline-success' %>"
                                                            onclick="toggleProductStatus('<%= product._id %>', '<%= product.isListed %>')"
                                                            title="<%= product.isListed ? 'Deactivate' : 'Activate' %>">
                                                            <i
                                                                class="fas <%= product.isListed ? 'fa-eye-slash' : 'fa-eye' %>"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                                            onclick="confirmDeleteProduct('<%= product._id %>')"
                                                            title="Delete">
                                                            <i class="fas fa-trash"></i>
                                                        </button>

                                                    </div>
                                                </td>
                                            </tr>
                                            <% }) %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="8" class="text-center py-4">
                                                            <div class="no-data">
                                                                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                                                                <h5>No Products Found</h5>
                                                                <p class="text-muted">Start by adding your first product
                                                                </p>
                                                                <a href="/admin/addproducts" class="btn btn-primary">
                                                                    <i class="fas fa-plus"></i> Add Product
                                                                </a>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <% } %>
                                </tbody>
                            </table>
                        </div>

                        <% if (totalPages> 1) { %>
                            <nav aria-label="Products pagination" class="mt-4">
                                <ul class="pagination justify-content-center">
                                    <% if (currentPage> 1) { %>
                                        <li class="page-item">
                                            <a class="page-link"
                                                href="?page=<%= currentPage - 1 %>&<%= new URLSearchParams(query).toString() %>">
                                                Previous
                                            </a>
                                        </li>
                                        <% } %>

                                            <% for (let i=Math.max(1, currentPage - 2); i <=Math.min(totalPages,
                                                currentPage + 2); i++) { %>
                                                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                                    <a class="page-link"
                                                        href="?page=<%= i %>&<%= new URLSearchParams(query).toString() %>">
                                                        <%= i %>
                                                    </a>
                                                </li>
                                                <% } %>

                                                    <% if (currentPage < totalPages) { %>
                                                        <li class="page-item">
                                                            <a class="page-link"
                                                                href="?page=<%= currentPage + 1 %>&<%= new URLSearchParams(query).toString() %>">
                                                                Next
                                                            </a>
                                                        </li>
                                                        <% } %>
                                </ul>
                            </nav>
                            <% } %>
                    </div>
                </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/js/admin/productManagement.js"></script>
         <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
  function confirmDeleteProduct(productId) {
    Swal.fire({
      title: 'Are you sure?',
      text: "Product will be permanently deleted!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, delete it!',
      reverseButtons: true
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/admin/deleteproduct/${productId}`, {
          method: 'DELETE'
        })
        .then(res => {
          if (res.ok) {
            Swal.fire('Deleted!', 'Product has been deleted.', 'success')
              .then(() => {
                location.reload();
              });
          } else {
            Swal.fire('Error!', 'Failed to delete the product.', 'error');
          }
        })
        .catch(err => {
          console.error(err);
          Swal.fire('Error!', 'Something went wrong.', 'error');
        });
      }
    });
  }
  
</script>

</body>

</html>